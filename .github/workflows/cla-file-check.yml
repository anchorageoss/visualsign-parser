name: cla-file-check

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

# Add permissions for the GitHub token to write comments to pull requests
permissions:
  contents: read
  pull-requests: write

jobs:
  check-cla-file:
    # Skip CLA check for bots (e.g., github-actions[bot], dependabot[bot])
    if: github.event.pull_request.user.type != 'Bot'
    runs-on: ubuntu-latest

    # Environment variables for easy configuration
    env:
      CLA_URL: "https://ironcladapp.com/public-launch/6896309b0f158de8c7450de6"
      MAINTAINER_TAG: "@anchorageoss/maintainers"

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout main branch for CLA file
        run: |
          git fetch origin main
          git checkout origin/main -- .cla-signed-users || echo "CLA file not found on main branch"

      - name: Check for username in .cla-signed-users
        id: check_user
        run: |
          if grep -v '^#' .cla-signed-users | grep -q -w "${{ github.event.pull_request.user.login }}"; then
            echo "✅ User found in .cla-signed-users file."
            echo "is_signed=true" >> $GITHUB_OUTPUT
          else
            echo "❌ User not found. Please acknowledge the CLA."
            echo "is_signed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if CLA comment already exists
        if: steps.check_user.outputs.is_signed == 'false'
        id: check_comment
        run: |
          # Check if github-actions bot has already commented about CLA on this PR
          COMMENTS=$(gh pr view ${{ github.event.pull_request.number }} --json comments --jq '.comments[] | select(.author.login == "github-actions") | .body')

          if echo "$COMMENTS" | grep -q "Contributor License Agreement"; then
            echo "CLA comment already exists, skipping"
            echo "comment_exists=true" >> $GITHUB_OUTPUT
          else
            echo "No CLA comment found, will post one"
            echo "comment_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR if user is not signed
        if: steps.check_user.outputs.is_signed == 'false' && steps.check_comment.outputs.comment_exists == 'false'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "Hi @${{ github.event.pull_request.user.login }}, thank you for your contribution!

          It looks like this is your first time contributing. To get this PR merged, please review our Contributor License Agreement (CLA) here: **${{ env.CLA_URL }}**

          Once you have reviewed the agreement, a maintainer (${{ env.MAINTAINER_TAG }}) will need to approve your addition to our contributors list by commenting \`/approve-cla\` on this PR. Thank you!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fail the check if user is not signed
        if: steps.check_user.outputs.is_signed == 'false'
        run: |
          echo "This check failed because the PR author has not signed the CLA."
          exit 1
